package voicemail;

import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;

import com.google.gson.*;


// API
// This API allows you to access the Voicemail DB after authorization.

// NOTES:
// If you notice the methods Add & Remove are currently private. Considering
// these are out of scope for this assignment the scaffolding will be left in,
// but incomplete.

public class API {
	private boolean _authorized = false;
	private JsonObject DB;
	private JsonObject user;	// user for current session
	private String DBPath = "/Users/henrysnopek/school/csc341/assignments/assignment07/src/voicemail/Voicemail-DB.json";
	
	public API() {
		_loadDB();
	}
	
	// Authorize Voicemail API Usage for number (user)
	public boolean Auth(double number, int code) {
		
		// Load user from matching number
		user = DB.get(String.valueOf(number)).getAsJsonObject();
		
		// If user number is equal to code set _authorized to true
		if (user.get("code").getAsInt() == code) _authorized = true;
		
		return _authorized;
	}
	
	// Add User to DB
	private boolean Add(User user) {
		if (!_authorized) return false;
		
		return true;
	}
	
	// Add voicemail to number, no authorization needed
	public void Add(double number, Voicemail voicemail) {
		Gson gson = new Gson();
		
		// Add JsonElement to Voicemails JsonArray
		JsonArray _users = DB.get("users").getAsJsonArray();
		JsonObject _user = new JsonObject();
		
		// Find _user with provided number
		for (int i = 0; i < _users.size(); i++) {
			_user = _users.get(i).getAsJsonObject();
			if (_user.get("number").getAsDouble() == number) break;
		}
		
		// Add voicemail to _user's voicemails
		_user.getAsJsonArray("voicemails").add(gson.toJson(voicemail));
		
		_user.get("voicemails").add();
	}
	
	// Remove User to DB
	private boolean Remove(User user) {
		if (!_authorized) return false;
		
		return true;
	}
	
	// Remove voicemail from current user session by index
	public boolean Remove(int index) {
		if (!_authorized) return false;
		
		user.get("voicemails").getAsJsonArray().remove(index);
		
		return true;
	}
	
	// GetAll: Returns all voicemails as JSONArray
	public JsonArray GetAll() {
		if (!_authorized) return null;
		
		JsonArray userVoicemails = user.get("voicemails").getAsJsonArray();
		
		return userVoicemails;
	}
	
	// Loads DB
	private void _loadDB() {
		String DBPath = "/Users/henrysnopek/school/csc341/assignments/assignment07/src/voicemail/Voicemail-DB.json";
		
		try {
			
			JsonParser parser = new JsonParser();
			JsonElement jsonElement = parser.parse(new FileReader(DBPath));
			DB = jsonElement.getAsJsonObject();
			
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}
		
		return;
	}
	
	// close session after saving, deauthorizes session
	public boolean CloseSession() {
		if (Save()) {
			_authorized = false;
			return true;
		} else return false;
	}
	
	// Ssaves the latest to the DB file
	private boolean Save() {
		
		Gson gson = new Gson();
		String json = gson.toJson(DB);
		
		try {
			//write converted json data to a file named "file.json"
			FileWriter writer = new FileWriter(DBPath);
			writer.write(json);
			writer.close();
	 
		} catch (IOException e) {
			e.printStackTrace();
			return false;
		}
		
		return true;
	}
}

interface User {
	public double number = 00000000000;
	public int password = 0000;
	public JsonArray voicemails = new JsonArray();
}

interface Voicemail {
	public double number = 00000000000;
	public String message = "";
	public boolean read = false;
}
